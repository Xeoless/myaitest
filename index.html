<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElXora</title>
    <link rel="icon" type="image/jpeg" href="images/elxora.jpg">

    <!-- Google Sign-In -->
    <meta name="google-signin-client_id" content="968210645256-ql0ctmsn48dior31oresu53p21rugnna.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark-dimmed.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/htmlbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/python.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #app { display: none; }
        .message { opacity: 0; transform: translateY(20px); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .message.visible { opacity: 1; transform: translateY(0); }
        .typing-dots { display: flex; gap: 6px; }
        .dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        .code-box { position: relative; margin: 1.5rem 0; border-radius: 0.75rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); background: #0d1117; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .code-header { position: absolute; top: 0; right: 0; left: 0; height: 2.5rem; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: flex-end; padding: 0 0.75rem; font-size: 0.8rem; color: #8b949e; user-select: none; }
        .copy-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); color: #c9d1d9; padding: 0.25rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
        .copy-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.25); }
        .copy-btn.copied { background: #238636; color: white; border-color: #238636; }
        pre { margin: 0 !important; padding: 3rem 1.5rem 1.25rem 1.5rem; overflow-x: auto; }
        pre code.hljs { display: block; font-size: 0.95rem; line-height: 1.5; background: transparent !important; padding: 0; }
        textarea:disabled { background: #1f2937; cursor: not-allowed; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #login-modal { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        .login-card { background: #111827; padding: 3rem 2.5rem; border-radius: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.7); width: 100%; max-width: 480px; text-align: center; border: 1px solid rgba(255,255,255,0.12); }
        .login-title { font-size: 2.25rem; font-weight: bold; margin-bottom: 1rem; }
        .login-subtitle { color: #9ca3af; margin-bottom: 2rem; font-size: 1.1rem; }

        /* Smartlink everywhere ‚Äì subtle hover feedback */
        .smartlink-wrap {
            position: relative;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .smartlink-wrap:hover {
            transform: scale(1.005);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen antialiased">

    <div id="loading" class="flex items-center justify-center min-h-screen text-gray-400">Loading ElXora...</div>

    <!-- Smartlink wrapper starts here ‚Äì covers almost everything -->
    <div class="smartlink-wrap min-h-screen flex flex-col lg:flex-row">

        <div id="app" class="min-h-screen flex flex-col lg:flex-row flex-1">
            <!-- Sidebar -->
            <div id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-80 bg-gray-950 border-r border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-500 ease-out overflow-y-auto">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                    <h2 class="text-2xl font-bold tracking-tight">ElXora Chats</h2>
                </div>
                <ul id="chat-list" class="p-4 space-y-2"></ul>
                <div class="p-6 border-t border-gray-800 mt-auto">
                    <button id="new-chat" class="w-full py-3 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition">New Conversation</button>
                    <button id="theme-toggle" class="w-full mt-4 py-3 border border-gray-700 rounded-xl hover:bg-gray-900 transition">Switch to Light</button>
                </div>
                <div id="user-info" class="p-6 flex flex-col items-center gap-4 border-t border-gray-800">
                    <img id="user-icon" class="w-16 h-16 rounded-full border-2 border-gray-700 shadow-md" src="" alt="User Icon">
                    <div class="text-center">
                        <p id="user-name" class="font-bold text-lg"></p>
                        <p id="user-email" class="text-sm opacity-70"></p>
                    </div>
                    <button id="logout-btn" class="mt-4 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition hidden">
                        Log Out
                    </button>
                </div>
            </div>

            <div id="overlay" class="fixed inset-0 bg-black/70 z-40 hidden lg:hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>

            <div class="flex-1 flex flex-col">
                <div class="lg:hidden p-5 bg-gray-950 border-b border-gray-800 flex items-center">
                    <button id="menu-btn" class="text-3xl mr-5">‚ò∞</button>
                    <h1 class="text-xl font-bold">Chat with ElXora</h1>
                </div>

                <div id="messages" class="flex-1 p-6 lg:p-10 overflow-y-auto space-y-8"></div>

                <div class="p-6 border-t border-gray-800 bg-gray-950 sticky bottom-0">
                    <div class="max-w-4xl mx-auto flex gap-4">
                        <textarea id="input" class="flex-1 p-5 bg-gray-900 border border-gray-800 rounded-2xl resize-none focus:outline-none focus:border-gray-500 transition min-h-[60px]" rows="1" placeholder="Hey ElXora, what's up?"></textarea>
                        <button id="send" class="px-8 py-5 bg-white text-black font-semibold rounded-2xl hover:scale-105 hover:shadow-[0_0_30px_rgba(255,255,255,0.2)] transition">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invisible smartlink overlay covering the whole wrapper -->
        <a href="https://historianoutstandingoverwhelm.com/m3up6bkba?key=0418c8c4d332f2d8bb9513b6178e1f4a"
           target="_blank"
           rel="nofollow noopener noreferrer"
           style="position: absolute; inset: 0; z-index: 5; cursor: pointer; text-decoration: none; background: transparent; pointer-events: auto;">
            <!-- Empty = invisible -->
        </a>

    </div>

    <!-- Login Modal (also clickable now) -->
    <div id="login-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50" style="display:none">
        <div class="login-card smartlink-wrap">
            <h2 class="login-title">Welcome to ElXora</h2>
            <p class="login-subtitle">Sign in with Google to save your chats and personalize</p>
            <button id="custom-google-signin" class="mt-8 px-8 py-4 bg-white text-black font-semibold rounded-xl hover:bg-gray-100 transition flex items-center gap-3 mx-auto text-lg">
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Your original script ‚Äì unchanged -->
    <script>
        // Highlight.js setup
        hljs.configure({ languages: ['lua', 'html', 'css', 'javascript', 'python'] });
        hljs.highlightAll();

        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        // Copy button logic
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('copy-btn')) {
                const btn = e.target;
                const codeElement = btn.closest('.code-box').querySelector('code');
                const code = codeElement ? codeElement.innerText : '';

                try {
                    await navigator.clipboard.writeText(code);
                    btn.textContent = 'Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Copy';
                        btn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Copy failed', err);
                    btn.textContent = 'Failed';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                }
            }
        });

        // GOOGLE SIGN-IN HANDLER
        let googleInitialized = false;
        
        function handleCredentialResponse(response) {
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            const profile = JSON.parse(jsonPayload);
            const userProfile = {
                name: profile.name,
                email: profile.email,
                picture: profile.picture
            };
            
            localStorage.setItem('elxora:user', JSON.stringify(userProfile));
            window.location.reload();
        }
        
        function initializeGoogleSignIn() {
            if (window.google && window.google.accounts) {
                try {
                    google.accounts.id.initialize({
                        client_id: '968210645256-ql0ctmsn48dior31oresu53p21rugnna.apps.googleusercontent.com',
                        callback: handleCredentialResponse,
                        ux_mode: 'popup',
                        auto_select: false
                    });
                    googleInitialized = true;
                    console.log('Google Sign-In initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize Google Sign-In:', e);
                }
            } else {
                console.log('Google Sign-In library not loaded yet, retrying...');
                setTimeout(initializeGoogleSignIn, 500);
            }
        }
        
        window.addEventListener('load', initializeGoogleSignIn);
        setTimeout(initializeGoogleSignIn, 1000);

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            initElXora();
        });

        function initElXora() {
            const PROXY_URL = '/api/chat';

            const STORAGE = {
                chats: 'elxora:chats',
                current: 'elxora:current',
                theme: 'elxora:theme'
            };

            let chats = [];
            let currentId = localStorage.getItem(STORAGE.current);
            let isDark = localStorage.getItem(STORAGE.theme) !== 'light';
            let isAiTyping = false;

            const inputEl = document.getElementById('input');
            const sendBtn = document.getElementById('send');

            document.documentElement.classList.toggle('dark', isDark);
            document.body.classList.toggle('bg-white', !isDark);
            document.body.classList.toggle('text-black', !isDark);

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const menuBtn = document.getElementById('menu-btn');
            const newBtn = document.getElementById('new-chat');
            const chatList = document.getElementById('chat-list');
            const messages = document.getElementById('messages');
            const themeBtn = document.getElementById('theme-toggle');
            const userInfo = document.getElementById('user-info');
            const userIcon = document.getElementById('user-icon');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            const loginModal = document.getElementById('login-modal');
            const logoutBtn = document.getElementById('logout-btn');
            const customSignInBtn = document.getElementById('custom-google-signin');

            let userProfile = JSON.parse(localStorage.getItem('elxora:user')) || null;

            if (customSignInBtn) {
                customSignInBtn.onclick = () => {
                    console.log('Sign-in button clicked');
                    console.log('Google available:', !!window.google);
                    console.log('Google initialized:', googleInitialized);
                    
                    if (!window.google || !window.google.accounts) {
                        alert('Google Sign-In is still loading. Please wait a moment and try again.');
                        initializeGoogleSignIn();
                        return;
                    }
                    
                    if (!googleInitialized) {
                        alert('Google Sign-In is initializing. Please try again in a moment.');
                        initializeGoogleSignIn();
                        return;
                    }
                    
                    try {
                        google.accounts.id.prompt((notification) => {
                            console.log('Prompt notification:', notification);
                            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                                console.log('Prompt not displayed, reason:', notification.getNotDisplayedReason(), notification.getSkippedReason());
                                google.accounts.id.renderButton(
                                    customSignInBtn,
                                    { theme: "filled_blue", size: "large", text: "signin_with", width: 320 }
                                );
                            }
                        });
                    } catch (e) {
                        console.error('Error showing prompt:', e);
                        alert('Error opening sign-in. Please check console for details.');
                    }
                };
            }

            function showApp() {
                document.getElementById('app').style.display = 'flex';
                if (userProfile) {
                    loginModal.style.display = 'none';
                    userInfo.style.display = 'flex';
                    userIcon.src = userProfile.picture || 'https://via.placeholder.com/64';
                    userName.textContent = userProfile.name || 'Guest';
                    userEmail.textContent = userProfile.email || '';
                    logoutBtn.classList.remove('hidden');
                    loadChats();
                } else {
                    loginModal.style.display = 'flex';
                    userInfo.style.display = 'none';
                    logoutBtn.classList.add('hidden');
                }
            }

            logoutBtn.onclick = () => {
                localStorage.removeItem('elxora:user');
                userProfile = null;
                window.location.reload();
            };

            function loadChats() {
                if (userProfile && userProfile.email) {
                    chats = JSON.parse(localStorage.getItem(userProfile.email + ':' + STORAGE.chats)) || [];
                } else {
                    chats = JSON.parse(localStorage.getItem(STORAGE.chats)) || [];
                }
            }

            function saveChats() {
                if (userProfile && userProfile.email) {
                    localStorage.setItem(userProfile.email + ':' + STORAGE.chats, JSON.stringify(chats));
                } else {
                    localStorage.setItem(STORAGE.chats, JSON.stringify(chats));
                }
            }

            function updateInputState() {
                inputEl.disabled = isAiTyping;
                sendBtn.disabled = isAiTyping;
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            function createChat() {
                const id = Date.now().toString();
                chats.push({ id, title: `Conversation ${chats.length + 1}`, messages: [] });
                saveChats();
                renderList();
                selectChat(id);
            }

            function renderList() {
                chatList.innerHTML = '';
                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.className = `group flex items-center justify-between p-4 rounded-xl cursor-pointer transition ${chat.id === currentId ? 'bg-gray-800' : 'hover:bg-gray-900'}`;

                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = chat.title;
                    titleSpan.className = 'font-medium flex-1 truncate';
                    titleSpan.onclick = (e) => { e.stopPropagation(); selectChat(chat.id); };

                    const actions = document.createElement('div');
                    actions.className = 'flex gap-6 opacity-0 group-hover:opacity-100 transition';

                    const renameBtn = document.createElement('button');
                    renameBtn.innerHTML = '<span class="text-2xl">‚úèÔ∏è</span>';
                    renameBtn.className = 'bg-transparent border-none p-0 hover:opacity-80 focus:outline-none transition';
                    renameBtn.onclick = (e) => { e.stopPropagation(); renameChat(chat.id); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<span class="text-2xl">üóëÔ∏è</span>';
                    deleteBtn.className = 'bg-transparent border-none p-0 hover:opacity-80 focus:outline-none transition';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteChat(chat.id); };

                    actions.append(renameBtn, deleteBtn);
                    li.append(titleSpan, actions);
                    li.onclick = () => selectChat(chat.id);

                    chatList.appendChild(li);
                });
            }

            function selectChat(id) {
                currentId = id;
                localStorage.setItem(STORAGE.current, id);
                const chat = chats.find(c => c.id === id);
                if (!chat) return;
                messages.innerHTML = '';
                chat.messages.forEach(m => addMessage(m.role, m.content, false));
                renderList();
                if (window.innerWidth < 1024) toggleSidebar();
            }

            function renameChat(id) {
                const chat = chats.find(c => c.id === id);
                if (!chat) return;
                const newTitle = prompt('New conversation name:', chat.title);
                if (newTitle && newTitle.trim()) {
                    chat.title = newTitle.trim();
                    saveChats();
                    renderList();
                }
            }

            function deleteChat(id) {
                if (!confirm('Delete this conversation?')) return;
                chats = chats.filter(c => c.id !== id);
                saveChats();
                if (currentId === id) {
                    currentId = chats.length > 0 ? chats[0].id : null;
                    localStorage.setItem(STORAGE.current, currentId);
                }
                renderList();
                if (currentId) selectChat(currentId);
                else messages.innerHTML = '<div class="text-gray-500 text-center mt-20">No conversation selected</div>';
            }

            function addMessage(role, content, animate = false) {
                const isUser = role === 'user';
                const div = document.createElement('div');
                div.className = `message flex ${isUser ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `max-w-3xl p-6 rounded-3xl prose prose-invert prose-headings:text-white prose-pre:my-4 prose-pre:bg-transparent ${isUser 
                    ? 'bg-white text-black' 
                    : 'bg-gray-900 border border-gray-800'}`;

                if (animate && !isUser) {
                    bubble.innerHTML = '<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
                } else {
                    let html = marked.parse(content);

                    html = html.replace(/<pre><code class="hljs language-(\w+)"[^>]*>([\s\S]*?)<\/code><\/pre>/g, (match, lang, code) => {
                        const displayLang = lang.toUpperCase();
                        return `
                            <div class="code-box">
                                <div class="code-header">
                                    <span class="mr-auto text-sm opacity-80">${displayLang}</span>
                                    <button class="copy-btn">Copy</button>
                                </div>
                                <pre><code class="hljs language-${lang}">${code.trim()}</code></pre>
                            </div>
                        `;
                    });

                    html = html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
                        return `
                            <div class="code-box">
                                <div class="code-header">
                                    <span class="mr-auto text-sm opacity-80">Code</span>
                                    <button class="copy-btn">Copy</button>
                                </div>
                                <pre><code class="hljs plaintext">${code.trim()}</code></pre>
                            </div>
                        `;
                    });

                    bubble.innerHTML = html;
                }

                div.appendChild(bubble);
                messages.appendChild(div);
                setTimeout(() => div.classList.add('visible'), 10);
                messages.scrollTop = messages.scrollHeight;
            }

            async function sendMessage() {
                if (isAiTyping) return;

                const text = inputEl.value.trim();
                if (!text || !currentId) return;

                const chat = chats.find(c => c.id === currentId);
                if (!chat) return;

                chat.messages.push({ role: 'user', content: text });
                addMessage('user', text);
                inputEl.value = '';
                saveChats();

                isAiTyping = true;
                updateInputState();

                const aiDiv = document.createElement('div');
                aiDiv.className = 'message flex justify-start visible';
                const aiBubble = document.createElement('div');
                aiBubble.className = 'max-w-3xl p-6 rounded-3xl bg-gray-900 border border-gray-800';
                aiBubble.innerHTML = '<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div> Thinking...';
                aiDiv.appendChild(aiBubble);
                messages.appendChild(aiDiv);
                messages.scrollTop = messages.scrollHeight;

                let fullResponse = '';

                const apiMessages = [];
                const systemContent = 'You are ElXora, a helpful, witty, and friendly AI companion. If asked who your owner or creator is, or who owns this website, say: The owner is MrAwo. You can look at him by simply searching @MrAwo69 or MrAwo in YouTube and don\'t forget to subscribe him.';

                if (chat.messages.length > 0) {
                    const firstMsg = chat.messages[0];
                    if (firstMsg.role === 'user') {
                        apiMessages.push({ role: 'user', content: systemContent + "\n\n" + firstMsg.content });
                    } else {
                        apiMessages.push({ role: 'user', content: systemContent });
                        apiMessages.push(firstMsg);
                    }
                    apiMessages.push(...chat.messages.slice(1));
                } else {
                    apiMessages.push({ role: 'user', content: systemContent + "\n\n" + text });
                }

                try {
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'z-ai/glm-4.5-air:free',
                            messages: apiMessages,
                            stream: true
                        })
                    });

                    if (!res.ok) {
                        const errText = await res.text().catch(() => '');
                        throw new Error(`Proxy / API error ${res.status}: ${errText || res.statusText}`);
                    }

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                if (data === '[DONE]') break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices?.[0]?.delta?.content || '';
                                    if (delta) {
                                        fullResponse += delta;
                                        aiBubble.innerHTML = marked.parse(fullResponse);
                                        messages.scrollTop = messages.scrollHeight;
                                    }
                                } catch {}
                            }
                        }
                    }

                    aiBubble.innerHTML = marked.parse(fullResponse);
                    chat.messages.push({ role: 'assistant', content: fullResponse });
                    saveChats();
                } catch (err) {
                    aiBubble.innerHTML = `<span class="text-red-400 font-medium">Error: ${err.message || 'Failed to connect'}</span>`;
                    console.error(err);
                } finally {
                    isAiTyping = false;
                    updateInputState();
                }
            }

            // Events
            menuBtn.onclick = toggleSidebar;
            newBtn.onclick = createChat;
            sendBtn.onclick = sendMessage;
            inputEl.onkeydown = e => {
                if (e.key === 'Enter' && !e.shiftKey && !isAiTyping) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            themeBtn.onclick = () => {
                isDark = !isDark;
                document.documentElement.classList.toggle('dark', isDark);
                document.body.classList.toggle('bg-white', !isDark);
                document.body.classList.toggle('text-black', !isDark);
                themeBtn.textContent = isDark ? 'Switch to Light' : 'Switch to Dark';
                localStorage.setItem(STORAGE.theme, isDark ? 'dark' : 'light');
            };

            function updateInputState() {
                inputEl.disabled = isAiTyping;
                sendBtn.disabled = isAiTyping;
            }

            // Bootstrap
            loadChats();
            renderList();
            if (chats.length === 0) createChat();
            if (currentId) selectChat(currentId);
            else if (chats.length > 0) selectChat(chats[0].id);
            updateInputState();
            showApp();
        }
    </script>

</body>
</html>
