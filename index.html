<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElXora – Black & White Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #app { display: none; }
        .message { opacity: 0; transform: translateY(20px); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .message.visible { opacity: 1; transform: translateY(0); }
        .typing-dots { display: flex; gap: 6px; }
        .dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        pre code { background: #111; color: #eee; padding: 1.2rem; border-radius: 12px; overflow-x: auto; }
    </style>
</head>
<body class="bg-black text-white min-h-screen antialiased">
    <div id="loading" class="flex items-center justify-center min-h-screen text-gray-400">Loading ElXora...</div>

    <div id="app" class="min-h-screen flex flex-col lg:flex-row">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed lg:static inset-y-0 left-0 z-50 w-80 bg-gray-950 border-r border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-500 ease-out overflow-y-auto">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-2xl font-bold tracking-tight">ElXora Chats</h2>
            </div>
            <ul id="chat-list" class="p-4 space-y-2"></ul>
            <div class="p-6 border-t border-gray-800 mt-auto">
                <button id="new-chat" class="w-full py-3 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition">New Conversation</button>
                <button id="theme-toggle" class="w-full mt-4 py-3 border border-gray-700 rounded-xl hover:bg-gray-900 transition">Switch to Light</button>
            </div>
        </div>

        <!-- Mobile overlay -->
        <div id="overlay" class="fixed inset-0 bg-black/70 z-40 hidden lg:hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>

        <!-- Main area -->
        <div class="flex-1 flex flex-col">
            <div class="lg:hidden p-5 bg-gray-950 border-b border-gray-800 flex items-center">
                <button id="menu-btn" class="text-3xl mr-5">☰</button>
                <h1 class="text-xl font-bold">Chat with ElXora</h1>
            </div>

            <div id="messages" class="flex-1 p-6 lg:p-10 overflow-y-auto space-y-8"></div>

            <div class="p-6 border-t border-gray-800 bg-gray-950 sticky bottom-0">
                <div class="max-w-4xl mx-auto flex gap-4">
                    <textarea id="input" class="flex-1 p-5 bg-gray-900 border border-gray-800 rounded-2xl resize-none focus:outline-none focus:border-gray-500 transition min-h-[60px]" rows="1" placeholder="Hey ElXora, what's up?"></textarea>
                    <button id="send" class="px-8 py-5 bg-white text-black font-semibold rounded-2xl hover:scale-105 hover:shadow-[0_0_30px_rgba(255,255,255,0.2)] transition">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            initElXora();
        });

        function initElXora() {
            const API_KEY = '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';

            const STORAGE = {
                chats: 'elxora:chats',
                current: 'elxora:current',
                theme: 'elxora:theme'
            };

            let chats = JSON.parse(localStorage.getItem(STORAGE.chats)) || [];
            let currentId = localStorage.getItem(STORAGE.current);
            let isDark = localStorage.getItem(STORAGE.theme) !== 'light';

            document.documentElement.classList.toggle('dark', isDark);
            document.body.classList.toggle('bg-white', !isDark);
            document.body.classList.toggle('text-black', !isDark);

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const menuBtn = document.getElementById('menu-btn');
            const newBtn = document.getElementById('new-chat');
            const chatList = document.getElementById('chat-list');
            const messages = document.getElementById('messages');
            const input = document.getElementById('input');
            const sendBtn = document.getElementById('send');
            const themeBtn = document.getElementById('theme-toggle');

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }

            function createChat() {
                const id = Date.now().toString();
                chats.push({ id, title: `Conversation ${chats.length + 1}`, messages: [] });
                saveChats();
                renderList();
                selectChat(id);
            }

            function saveChats() {
                localStorage.setItem(STORAGE.chats, JSON.stringify(chats));
            }

            function renderList() {
                chatList.innerHTML = '';
                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.className = `group flex items-center justify-between p-4 rounded-xl cursor-pointer transition ${chat.id === currentId ? 'bg-gray-800' : 'hover:bg-gray-900'}`;

                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = chat.title;
                    titleSpan.className = 'font-medium flex-1 truncate';
                    titleSpan.onclick = (e) => {
                        e.stopPropagation();
                        selectChat(chat.id);
                    };

                    const actions = document.createElement('div');
                    actions.className = 'flex gap-3 opacity-0 group-hover:opacity-100 transition';

                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = 'Rename';
                    renameBtn.className = 'text-sm text-gray-400 hover:text-white';
                    renameBtn.onclick = (e) => {
                        e.stopPropagation();
                        renameChat(chat.id);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'text-sm text-red-400 hover:text-red-300';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteChat(chat.id);
                    };

                    actions.append(renameBtn, deleteBtn);
                    li.append(titleSpan, actions);
                    li.onclick = () => selectChat(chat.id);

                    chatList.appendChild(li);
                });
            }

            function selectChat(id) {
                currentId = id;
                localStorage.setItem(STORAGE.current, id);
                const chat = chats.find(c => c.id === id);
                if (!chat) return;
                messages.innerHTML = '';
                chat.messages.forEach(m => addMessage(m.role, m.content, false));
                renderList();
                if (window.innerWidth < 1024) toggleSidebar();
            }

            function renameChat(id) {
                const chat = chats.find(c => c.id === id);
                if (!chat) return;
                const newTitle = prompt('New conversation name:', chat.title);
                if (newTitle && newTitle.trim()) {
                    chat.title = newTitle.trim();
                    saveChats();
                    renderList();
                }
            }

            function deleteChat(id) {
                if (!confirm('Delete this conversation?')) return;
                chats = chats.filter(c => c.id !== id);
                saveChats();
                if (currentId === id) {
                    currentId = chats.length > 0 ? chats[0].id : null;
                    localStorage.setItem(STORAGE.current, currentId);
                }
                renderList();
                if (currentId) selectChat(currentId);
                else messages.innerHTML = '<div class="text-gray-500 text-center mt-20">No conversation selected</div>';
            }

            function addMessage(role, content, animate = false) {
                const isUser = role === 'user';
                const div = document.createElement('div');
                div.className = `message flex ${isUser ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `max-w-3xl p-6 rounded-3xl prose prose-invert prose-headings:text-white ${isUser 
                    ? 'bg-white text-black' 
                    : 'bg-gray-900 border border-gray-800'}`;
                
                if (animate && !isUser) {
                    bubble.innerHTML = '<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
                } else {
                    bubble.innerHTML = marked.parse(content);
                }

                div.appendChild(bubble);
                messages.appendChild(div);
                setTimeout(() => div.classList.add('visible'), 10);
                messages.scrollTop = messages.scrollHeight;
            }

            async function sendMessage() {
                const text = input.value.trim();
                if (!text || !currentId) return;

                const chat = chats.find(c => c.id === currentId);
                if (!chat) return;

                chat.messages.push({ role: 'user', content: text });
                addMessage('user', text);
                input.value = '';
                saveChats();

                const aiDiv = document.createElement('div');
                aiDiv.className = 'message flex justify-start visible';
                const aiBubble = document.createElement('div');
                aiBubble.className = 'max-w-3xl p-6 rounded-3xl bg-gray-900 border border-gray-800';
                aiBubble.innerHTML = '<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div> Thinking...';
                aiDiv.appendChild(aiBubble);
                messages.appendChild(aiDiv);
                messages.scrollTop = messages.scrollHeight;

                let fullResponse = '';

                try {
                    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'https://elxora-chat.pages.dev', // optional – helps with leaderboard
                            'X-Title': 'ElXora Chat'
                        },
                        body: JSON.stringify({
                            model: 'google/gemma-3-27b-it:free',
                            messages: [{ role: 'system', content: 'You are ElXora.' }, ...chat.messages],
                            stream: true
                        })
                    });

                    if (!res.ok) {
                        const errText = await res.text().catch(() => '');
                        throw new Error(`API error ${res.status}: ${errText || res.statusText}`);
                    }

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                if (data === '[DONE]') break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices?.[0]?.delta?.content || '';
                                    if (delta) {
                                        fullResponse += delta;
                                        aiBubble.textContent = fullResponse;
                                        messages.scrollTop = messages.scrollHeight;
                                    }
                                } catch {}
                            }
                        }
                    }

                    aiBubble.innerHTML = marked.parse(fullResponse);
                    chat.messages.push({ role: 'assistant', content: fullResponse });
                    saveChats();
                } catch (err) {
                    aiBubble.innerHTML = `<span class="text-red-400 font-medium">Error: ${err.message || 'Failed to connect to ElXora brain'}</span><br><small class="text-gray-500">(Check your API key or credits on openrouter.ai)</small>`;
                    console.error(err);
                }
            }

            // Events
            menuBtn.onclick = toggleSidebar;
            newBtn.onclick = createChat;
            sendBtn.onclick = sendMessage;
            input.onkeydown = e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            themeBtn.onclick = () => {
                isDark = !isDark;
                document.documentElement.classList.toggle('dark', isDark);
                document.body.classList.toggle('bg-white', !isDark);
                document.body.classList.toggle('text-black', !isDark);
                themeBtn.textContent = isDark ? 'Switch to Light' : 'Switch to Dark';
                localStorage.setItem(STORAGE.theme, isDark ? 'dark' : 'light');
            };

            // Bootstrap
            renderList();
            if (chats.length === 0) createChat();
            if (currentId) selectChat(currentId);
            else if (chats.length > 0) selectChat(chats[0].id);
        }
    </script>
</body>
    </html>
